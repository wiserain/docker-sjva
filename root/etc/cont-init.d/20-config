#!/usr/bin/with-contenv bash
set -e

app_root="${APP_ROOT:-/app}"
app_root="${app_root%%/}"
app_src="https://github.com/soju6jan/sjva2_src_obfuscate.git"

cd "${app_root}"

# persistent export.sh
[[ ! -f "${app_root}/data/export.sh" ]] && \
  cp /defaults/config "${app_root}/data/export.sh"
chmod a+x "${app_root}/data/export.sh"
ln -sf "${app_root}/data/export.sh" "${app_root}/export.sh"

# install and update app
if [ -d "${app_root}/.git" ]; then
  find "${app_root}" -name "index.lock" -exec rm -f '{}' \;
  git reset --quiet --hard HEAD
  echo "*** checking for updates..."
  git pull origin master --depth 1 --rebase
else
  find "${app_root}/data" -type f -name "*.pyc" -o -name "*.pyo" -exec rm -f '{}' \;
  find "${app_root}" -mindepth 1 -maxdepth 1 ! \( -name data -o -name export.sh \) -exec rm -rf '{}' \;
  echo "*** installing app to '${app_root}'..."
  git init --quiet > /dev/null
  git remote add origin "${app_src}"
  git pull --quiet origin master --depth 1 --rebase
fi

# dirs
mkdir -p \
  "${app_root}/bin" \
  "${app_root}/data/custom"

# init db
if [ ! -f "${app_root}/data/db/sjva.db" ] ; then
  echo "*** initializing db..."
  python sjva.py 0 0 init_db
fi

# permissions
chown -R abc:abc \
  "${app_root}"

# really necessary?
# chmod 777 .
